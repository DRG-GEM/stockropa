<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - Cooperativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .detail-view {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .detail-view.active {
            max-height: 1000px; /* Suficientemente grande para el contenido */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-6">

        <!-- Cabecera y Navegación -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-sky-500 text-white p-2 rounded-lg">
                    <i class="fas fa-boxes-stacked"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-700">Gestión de Stock</h1>
            </div>
            <div id="nav-buttons" class="flex gap-2">
                 <button id="btn-inicio" class="bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-sky-600 transition-colors">Registrar</button>
                 <button id="btn-ver-stock" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Ver Stock</button>
                 <button id="btn-carga-masiva" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Carga Masiva</button>
            </div>
        </header>

        <!-- Contenedor de Pantallas -->
        <main id="screens-container">

            <!-- Pantalla de Registro (Ahora es una sola pantalla dinámica) -->
            <div id="screen-registro" class="screen active">
                <div id="seccion-selector">
                    <h2 class="text-lg font-semibold mb-4 text-center">1. Selecciona una sección:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button data-seccion="Guardería" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                            <i class="fas fa-child-reaching text-4xl text-teal-500 mb-3"></i>
                            <span class="block text-xl font-bold">Guardería</span>
                        </button>
                        <button data-seccion="Resto de Alumnos" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                            <i class="fas fa-user-graduate text-4xl text-indigo-500 mb-3"></i>
                            <span class="block text-xl font-bold">Resto de Alumnos</span>
                        </button>
                    </div>
                </div>

                <div id="prenda-selector" class="hidden mt-8">
                    <h2 class="text-lg font-semibold mb-4 text-center">2. Selecciona una prenda:</h2>
                    <div id="prendas-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="detail-view-container" class="detail-view mt-6">
                    <button id="back-to-prendas" class="mb-4 text-slate-500 hover:text-slate-800">&larr; Volver a prendas</button>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 id="detail-title" class="text-2xl font-bold mb-6 text-center"></h2>
                        <div id="detail-options" class="space-y-6"></div>
                    </div>
                </div>
            </div>

            <!-- Pantalla de Ver Stock -->
            <div id="screen-stock" class="screen">
                 <h2 class="text-2xl font-bold mb-4">Inventario Actual</h2>
                 <div class="flex justify-between items-center mb-4">
                    <input type="text" id="stock-search" placeholder="Buscar prenda..." class="p-2 border border-slate-300 rounded-lg w-1/2">
                    <button id="btn-export-csv" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar a CSV
                    </button>
                 </div>
                 <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left whitespace-nowrap">Prenda</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Almacén</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Tienda VP</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Tienda PII</th>
                                <th scope="col" class="px-4 py-3 text-center font-bold whitespace-nowrap">Total</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body">
                           <tr><td colspan="5" class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-sky-500"></i><p class="mt-2">Cargando stock...</p></td></tr>
                        </tbody>
                    </table>
                 </div>
                 <p class="text-xs text-slate-400 text-right mt-2 md:hidden">← Desliza la tabla para ver más →</p>
            </div>

            <!-- Pantalla de Carga Masiva -->
            <div id="screen-bulk-load" class="screen">
                <h2 class="text-2xl font-bold mb-4">Carga Masiva de Stock</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="mb-4">
                        <label for="bulk-product-select" class="block text-sm font-medium text-slate-700 mb-1">Selecciona una Prenda</label>
                        <select id="bulk-product-select" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="">-- Elige un producto --</option>
                        </select>
                    </div>
                    <div id="bulk-load-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6"></div>
                    <button id="btn-bulk-save" class="w-full mt-6 bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-transform transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>Guardar Cambios</button>
                </div>
            </div>

        </main>

        <!-- Modal de Confirmación -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 text-center max-w-sm mx-auto">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                     <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <h3 id="modal-title" class="text-lg font-medium text-slate-900">¡Hecho!</h3>
                <p id="modal-message" class="text-sm text-slate-500 mt-2"></p>
                <button id="modal-close" class="mt-4 w-full bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold">Aceptar</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, increment, collection, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD1Zujz9sNiG7GYLkv5wUFWOPDIbF6DrBU",
          authDomain: "stock-ropa.firebaseapp.com",
          projectId: "stock-ropa",
          storageBucket: "stock-ropa.appspot.com",
          messagingSenderId: "289770874193",
          appId: "1:289770874193:web:37cb97c578bde1a1b89f70"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const SECRET_KEY = "stock-cooperativa-2a8b3c4d-1e9f-4b2c-8d7e-5f6a7b8c9d0e";

        const productos = {
          "Guardería": { "Babi": { tallas: ["00", "0", "1", "2", "3"] }, "Camiseta": { "Manga Corta": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Manga Larga": { tallas: ["00", "0", "1", "2", "3", "4"] } }, "Pantalón": { "Corto": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Largo": { tallas: ["00", "0", "1", "2", "3", "4", "6"] } }, "Malla": { tallas: ["00", "0", "1", "2", "3"] }, "Chaqueta": { tallas: ["00", "0", "1", "2", "3", "4"] }, "Chándal": { tallas: ["3", "4"] } },
          "Resto de Alumnos": { "Pantalón mostaza": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] }, "Largo": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] } }, "Polo": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] } }, "Falda": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)", "48"] }, "Sueter": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)"] }, "Babi infantil": { tallas: ["1", "2", "4", "6"] }, "Chándal": { tallas: ["1", "2", "3", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Sport": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Largo": { tallas: ["2", "3", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Malla Sport": { tallas: ["12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Camiseta": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Sudadera": { tallas: ["XS", "S", "M", "L", "XL", "XXL", "XXXL"] }, "Leotardos": { tallas: ["4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL"] }, "Calcetines": { tallas: ["4", "6", "8", "10", "12", "14"] }, "Calcetas": { tallas: ["4", "6", "8", "10", "12", "14"] } }
        };
        const iconosPrendas = { "Babi": "fas fa-shirt", "Camiseta": "fas fa-tshirt", "Pantalón": "fas fa-user-tie", "Malla": "fas fa-socks", "Chaqueta": "fas fa-user-secret", "Chándal": "fas fa-running", "Pantalón mostaza": "fas fa-user-tie", "Polo": "fas fa-tshirt", "Falda": "fas fa-female", "Sueter": "fas fa-user-ninja", "Babi infantil": "fas fa-child", "Sport": "fas fa-volleyball-ball", "Malla Sport": "fas fa-running", "Sudadera": "fas fa-user-secret", "Leotardos": "fas fa-socks", "Calcetines": "fas fa-socks", "Calcetas": "fas fa-socks", "default": "fas fa-tag" };

        let seleccion = { seccion: null, prenda: null, variante: null, talla: null };
        let stockData = [];

        const screens = document.querySelectorAll('.screen');
        const modal = document.getElementById('modal');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');
        
        // Elementos de Navegación y Pantallas
        const btnInicio = document.getElementById('btn-inicio');
        const btnVerStock = document.getElementById('btn-ver-stock');
        const btnCargaMasiva = document.getElementById('btn-carga-masiva');
        const seccionSelector = document.getElementById('seccion-selector');
        const prendaSelector = document.getElementById('prenda-selector');
        const prendasGrid = document.getElementById('prendas-grid');
        const detailViewContainer = document.getElementById('detail-view-container');
        const detailTitle = document.getElementById('detail-title');
        const detailOptions = document.getElementById('detail-options');
        const backToPrendasBtn = document.getElementById('back-to-prendas');

        function goToScreen(screenId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            btnInicio.classList.toggle('bg-sky-500', screenId === 'screen-registro');
            btnInicio.classList.toggle('bg-slate-200', screenId !== 'screen-registro');
            btnVerStock.classList.toggle('bg-sky-500', screenId === 'screen-stock');
            btnVerStock.classList.toggle('bg-slate-200', screenId !== 'screen-stock');
            btnCargaMasiva.classList.toggle('bg-sky-500', screenId === 'screen-bulk-load');
            btnCargaMasiva.classList.toggle('bg-slate-200', screenId !== 'screen-bulk-load');
        }

        // --- NUEVO FLUJO DE REGISTRO ---
        
        document.querySelectorAll('.seccion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                seleccion.seccion = btn.dataset.seccion;
                seccionSelector.classList.add('hidden');
                prendaSelector.classList.remove('hidden');
                renderPrendas(seleccion.seccion);
            });
        });

        function renderPrendas(seccion) {
            prendasGrid.innerHTML = '';
            const prendas = productos[seccion];
            for (const prendaNombre in prendas) {
                const iconClass = iconosPrendas[prendaNombre] || iconosPrendas['default'];
                const button = document.createElement('button');
                button.className = 'prenda-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center fade-in';
                button.dataset.prenda = prendaNombre;
                button.innerHTML = `<i class="${iconClass} text-3xl text-slate-500 mb-2"></i><span class="block text-md font-semibold">${prendaNombre}</span>`;
                prendasGrid.appendChild(button);
            }
        }
        
        prendasGrid.addEventListener('click', (e) => {
            const prendaBtn = e.target.closest('.prenda-btn');
            if (!prendaBtn) return;

            seleccion.prenda = prendaBtn.dataset.prenda;
            prendaSelector.classList.add('hidden');
            detailViewContainer.classList.add('active');
            renderDetailView();
        });

        backToPrendasBtn.addEventListener('click', () => {
            detailViewContainer.classList.remove('active');
            prendaSelector.classList.remove('hidden');
            seleccion.prenda = null;
            seleccion.variante = null;
            seleccion.talla = null;
        });

        function renderDetailView() {
            const { seccion, prenda } = seleccion;
            const item = productos[seccion][prenda];
            detailTitle.textContent = prenda;
            detailOptions.innerHTML = '';

            let variantsHTML = '';
            const hasVariants = !item.tallas;
            if (hasVariants) {
                const variantKeys = Object.keys(item);
                seleccion.variante = variantKeys[0]; // Seleccionar la primera por defecto
                variantsHTML = `
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Variante</label>
                        <div class="flex gap-2">${variantKeys.map((v, i) => `
                            <button class="variant-btn flex-1 p-2 rounded-lg border-2 ${i === 0 ? 'bg-sky-100 border-sky-500' : 'bg-white'}" data-variante="${v}">${v}</button>
                        `).join('')}</div>
                    </div>
                `;
            } else {
                seleccion.variante = null;
            }

            detailOptions.innerHTML += variantsHTML;
            detailOptions.innerHTML += `
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Talla</label>
                    <div id="detail-tallas-grid" class="grid grid-cols-4 sm:grid-cols-6 gap-2"></div>
                </div>
                <div>
                    <label for="detail-cantidad" class="block text-sm font-medium text-slate-700 mb-1">Cantidad</label>
                    <input type="number" id="detail-cantidad" min="1" value="1" class="w-full p-3 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Movimiento</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="detail-btn-entrada" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-semibold"><i class="fas fa-plus mr-2"></i>Entrada Almacén</button>
                        <button id="detail-btn-salida" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-slate-300 text-slate-500 font-semibold"><i class="fas fa-minus mr-2"></i>Salida a Tienda</button>
                    </div>
                </div>
                <div id="detail-destino-container" class="hidden">
                    <label for="detail-destino" class="block text-sm font-medium text-slate-700 mb-1">Destino</label>
                    <select id="detail-destino" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                        <option value="tiendaVP">Tienda VP</option>
                        <option value="tiendaPII">Tienda PII</option>
                    </select>
                </div>
                <button id="detail-btn-confirmar" class="w-full bg-sky-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-sky-600 disabled:bg-slate-300" disabled>Confirmar Movimiento</button>
            `;
            renderDetailTallas();
            addDetailListeners();
        }

        function renderDetailTallas() {
            const { seccion, prenda, variante } = seleccion;
            const item = variante ? productos[seccion][prenda][variante] : productos[seccion][prenda];
            const tallasGrid = document.getElementById('detail-tallas-grid');
            tallasGrid.innerHTML = ''; // Clear existing buttons

            item.tallas.forEach(talla => {
                // Find the stock data for this specific item
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const stockItem = stockData.find(d => d.id === docId);

                const stockAlmacen = stockItem ? stockItem.stockAlmacen || 0 : 0;
                
                const buttonHTML = `
                    <button class="detail-talla-btn bg-white p-2 text-sm rounded-lg border-2 flex flex-col items-center justify-center h-16" data-talla="${talla}">
                        <span class="font-bold text-base">${talla}</span>
                        <span class="text-xs bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded-full mt-1">Disp: ${stockAlmacen}</span>
                    </button>
                `;
                tallasGrid.innerHTML += buttonHTML;
            });
        }

        function addDetailListeners() {
            detailOptions.addEventListener('click', (e) => {
                // Seleccionar Variante
                if (e.target.matches('.variant-btn')) {
                    document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                    e.target.classList.add('bg-sky-100', 'border-sky-500');
                    seleccion.variante = e.target.dataset.variante;
                    seleccion.talla = null; // Deseleccionar talla al cambiar variante
                    document.getElementById('detail-btn-confirmar').disabled = true;
                    renderDetailTallas();
                }
                // Seleccionar Talla
                if (e.target.matches('.detail-talla-btn')) {
                    document.querySelectorAll('.detail-talla-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                    e.target.classList.add('bg-sky-100', 'border-sky-500');
                    seleccion.talla = e.target.dataset.talla;
                    document.getElementById('detail-btn-confirmar').disabled = false;
                }
                // Tipo de Movimiento
                if (e.target.closest('#detail-btn-entrada')) {
                    document.getElementById('detail-btn-entrada').classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                    document.getElementById('detail-btn-salida').classList.remove('border-red-500', 'bg-red-50', 'text-red-700');
                    document.getElementById('detail-destino-container').classList.add('hidden');
                }
                if (e.target.closest('#detail-btn-salida')) {
                    document.getElementById('detail-btn-salida').classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                    document.getElementById('detail-btn-entrada').classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
                    document.getElementById('detail-destino-container').classList.remove('hidden');
                }
                // Confirmar
                if (e.target.matches('#detail-btn-confirmar')) {
                    handleConfirmClick();
                }
            });
        }

        async function handleConfirmClick() {
            const cantidad = parseInt(document.getElementById('detail-cantidad').value);
            if (!cantidad || cantidad < 1) {
                showModal('Error', 'La cantidad debe ser un número mayor que cero.', 'error');
                return;
            }
            const confirmBtn = document.getElementById('detail-btn-confirmar');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            
            const esSalida = document.getElementById('detail-btn-salida').classList.contains('border-red-500');
            
            const docId = `${seleccion.seccion}_${seleccion.prenda}_${seleccion.variante || ''}_${seleccion.talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
            const docRef = doc(db, SECRET_KEY, docId);
            
            try {
                const docSnap = await getDoc(docRef);
                let updateData = {};
                
                if (!esSalida) {
                    updateData.stockAlmacen = increment(cantidad);
                } else {
                    const destino = document.getElementById('detail-destino').value;
                    updateData.stockAlmacen = increment(-cantidad);
                    updateData[destino === 'tiendaVP' ? 'stockVP' : 'stockPII'] = increment(cantidad);
                }

                if (!docSnap.exists()) {
                    const initialData = {
                        seccion: seleccion.seccion, prenda: seleccion.prenda, variante: seleccion.variante || '', talla: seleccion.talla,
                        stockAlmacen: 0, stockVP: 0, stockPII: 0, ...updateData
                    };
                    await setDoc(docRef, initialData);
                } else {
                    await setDoc(docRef, updateData, { merge: true });
                }

                showModal('¡Hecho!', 'El movimiento de stock ha sido registrado correctamente.');
                resetApp();

            } catch (error) {
                console.error("Error al actualizar el documento: ", error);
                showModal('Error', 'No se pudo registrar el movimiento.', 'error');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Confirmar Movimiento';
            }
        }
        
        function resetApp() {
            seleccion = { seccion: null, prenda: null, variante: null, talla: null };
            seccionSelector.classList.remove('hidden');
            prendaSelector.classList.add('hidden');
            detailViewContainer.classList.remove('active');
            goToScreen('screen-registro');
        }

        function showModal(title, message, type = 'success') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.innerHTML = '';
            if (type === 'success') {
                modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4';
                modalIcon.innerHTML = '<i class="fas fa-check text-green-600 text-2xl"></i>';
            } else {
                modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4';
                modalIcon.innerHTML = '<i class="fas fa-times text-red-600 text-2xl"></i>';
            }
            modal.classList.remove('hidden');
        }
        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        // Navegación principal
        btnInicio.addEventListener('click', () => {
            resetApp();
        });
        btnVerStock.addEventListener('click', () => {
            goToScreen('screen-stock');
        });
        btnCargaMasiva.addEventListener('click', () => {
            goToScreen('screen-bulk-load');
        });
        
        // --- CÓDIGO ANTERIOR (STOCK, CARGA MASIVA, ETC) SIN CAMBIOS ---
        const stockSearchInput = document.getElementById('stock-search');
        const btnExportCSV = document.getElementById('btn-export-csv');
        const bulkProductSelect = document.getElementById('bulk-product-select');
        const bulkLoadGrid = document.getElementById('bulk-load-grid');
        const btnBulkSave = document.getElementById('btn-bulk-save');

        function renderStockTable(data) {
            const tableBody = document.getElementById('stock-table-body');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8">No hay datos de stock.</td></tr>';
                return;
            }
            data.sort((a, b) => {
                if (a.seccion < b.seccion) return -1; if (a.seccion > b.seccion) return 1;
                if (a.prenda < b.prenda) return -1; if (a.prenda > b.prenda) return 1;
                if (a.variante < b.variante) return -1; if (a.variante > b.variante) return 1;
                const tallaA = parseInt(a.talla); const tallaB = parseInt(b.talla);
                if (!isNaN(tallaA) && !isNaN(tallaB)) { return tallaA - tallaB; }
                return a.talla.localeCompare(b.talla);
            });
            data.forEach(item => {
                const total = (item.stockAlmacen || 0) + (item.stockVP || 0) + (item.stockPII || 0);
                const nombreCompleto = `${item.prenda} ${item.variante || ''} - Talla: ${item.talla}`;
                const row = `<tr class="bg-white border-b hover:bg-slate-50"><th scope="row" class="px-4 py-4 font-medium text-slate-900 whitespace-nowrap"><span class="block">${nombreCompleto}</span><span class="block text-xs text-slate-400">${item.seccion}</span></th><td class="px-4 py-4 text-center">${item.stockAlmacen || 0}</td><td class="px-4 py-4 text-center">${item.stockVP || 0}</td><td class="px-4 py-4 text-center">${item.stockPII || 0}</td><td class="px-4 py-4 text-center font-bold text-slate-800">${total}</td></tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        onSnapshot(collection(db, SECRET_KEY), (querySnapshot) => {
            stockData = [];
            querySnapshot.forEach((doc) => {
                stockData.push({ id: doc.id, ...doc.data() });
            });
            renderStockTable(stockData);
        });

        stockSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = stockData.filter(item => `${item.seccion} ${item.prenda} ${item.variante || ''} ${item.talla}`.toLowerCase().includes(searchTerm));
            renderStockTable(filteredData);
        });
        
        btnExportCSV.addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,Seccion,Prenda,Variante,Talla,Stock Almacen,Stock Tienda VP,Stock Tienda PII,Total\n";
            stockData.forEach(item => {
                const total = (item.stockAlmacen || 0) + (item.stockVP || 0) + (item.stockPII || 0);
                const row = [item.seccion, item.prenda, item.variante || '', item.talla, item.stockAlmacen || 0, item.stockVP || 0, item.stockPII || 0, total].join(",");
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "inventario_cooperativa.csv");
            link.click();
        });
        
        function populateBulkProductSelect() {
            for (const seccion in productos) {
                for (const prenda in productos[seccion]) {
                    const item = productos[seccion][prenda];
                    if (item.tallas) {
                        const option = document.createElement('option');
                        option.value = `${seccion}|${prenda}`;
                        option.textContent = `${seccion} - ${prenda}`;
                        bulkProductSelect.appendChild(option);
                    } else {
                        for (const variante in item) {
                            const option = document.createElement('option');
                            option.value = `${seccion}|${prenda}|${variante}`;
                            option.textContent = `${seccion} - ${prenda} (${variante})`;
                            bulkProductSelect.appendChild(option);
                        }
                    }
                }
            }
        }

        bulkProductSelect.addEventListener('change', async (e) => {
            const value = e.target.value;
            bulkLoadGrid.innerHTML = '<div class="col-span-full text-center"><i class="fas fa-spinner fa-spin text-2xl text-sky-500"></i></div>';
            btnBulkSave.disabled = true;
            if (!value) { bulkLoadGrid.innerHTML = ''; return; }

            const [seccion, prenda, variante] = value.split('|');
            const item = variante ? productos[seccion][prenda][variante] : productos[seccion][prenda];
            
            bulkLoadGrid.innerHTML = '';
            for (const talla of item.tallas) {
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const docSnap = await getDoc(doc(db, SECRET_KEY, docId));
                const currentStock = docSnap.exists() ? docSnap.data().stockAlmacen || 0 : 0;
                bulkLoadGrid.innerHTML += `<div><label class="block text-sm font-medium text-slate-700 mb-1">${talla}</label><input type="number" min="0" value="${currentStock}" class="w-full p-2 border border-slate-300 rounded-lg" data-talla="${talla}"></div>`;
            }
            btnBulkSave.disabled = false;
        });

        btnBulkSave.addEventListener('click', async () => {
            const value = bulkProductSelect.value;
            if (!value) return;
            btnBulkSave.disabled = true;
            btnBulkSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            const [seccion, prenda, variante] = value.split('|');
            const batch = writeBatch(db);

            bulkLoadGrid.querySelectorAll('input').forEach(input => {
                const talla = input.dataset.talla;
                const newStock = parseInt(input.value) || 0;
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const data = { seccion, prenda, variante: variante || '', talla, stockAlmacen: newStock };
                batch.set(doc(db, SECRET_KEY, docId), data, { merge: true });
            });

            try {
                await batch.commit();
                showModal('¡Guardado!', 'El stock se ha actualizado correctamente.');
            } catch (error) {
                console.error("Error en carga masiva: ", error);
                showModal('Error', 'No se pudo guardar el stock.', 'error');
            } finally {
                btnBulkSave.disabled = false;
                btnBulkSave.innerHTML = 'Guardar Cambios';
            }
        });

        // Inicialización
        populateBulkProductSelect();
        goToScreen('screen-registro');

    </script>
</body>
</html>
