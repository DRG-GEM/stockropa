<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - Cooperativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Panel de Error para Diagnóstico -->
    <div id="error-panel" class="hidden fixed top-0 left-0 right-0 bg-red-600 text-white p-4 text-sm z-50 shadow-lg">
        <h4 class="font-bold mb-1">Error en la aplicación</h4>
        <p id="error-message">Ha ocurrido un error al iniciar la aplicación.</p>
    </div>

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-6 pt-16">

        <!-- Cabecera y Navegación -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-sky-500 text-white p-2 rounded-lg">
                    <i class="fas fa-boxes-stacked"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-700">Gestión de Stock</h1>
            </div>
            <div id="nav-buttons">
                 <button id="btn-ver-stock" class="bg-slate-200 text-slate-600 px-4 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Ver Stock</button>
                 <button id="btn-inicio" class="bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-sky-600 transition-colors hidden">Registrar Movimiento</button>
            </div>
        </header>

        <!-- Contenedor de Pantallas -->
        <main id="screens-container">

            <!-- Pantalla 0: Inicio -->
            <div id="screen-inicio" class="screen active">
                <h2 class="text-lg font-semibold mb-4 text-center">Selecciona una sección:</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button data-seccion="Guardería" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                        <i class="fas fa-child-reaching text-4xl text-teal-500 mb-3"></i>
                        <span class="block text-xl font-bold">Guardería</span>
                    </button>
                    <button data-seccion="Resto de Alumnos" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                        <i class="fas fa-user-graduate text-4xl text-indigo-500 mb-3"></i>
                        <span class="block text-xl font-bold">Resto de Alumnos</span>
                    </button>
                </div>
            </div>

            <!-- El resto de las pantallas (prendas, tallas, etc.) van aquí -->
            <div id="screen-prendas" class="screen">
                <button class="back-btn mb-4 text-slate-500 hover:text-slate-800">&larr; Volver a Secciones</button>
                <h2 class="text-lg font-semibold mb-4 text-center">Selecciona una prenda:</h2>
                <div id="prendas-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>

            <div id="screen-variantes" class="screen">
                <button class="back-btn mb-4 text-slate-500 hover:text-slate-800">&larr; Volver a Prendas</button>
                <h2 class="text-lg font-semibold mb-4 text-center">Selecciona una variante:</h2>
                <div id="variantes-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <div id="screen-tallas" class="screen">
                <button class="back-btn mb-4 text-slate-500 hover:text-slate-800">&larr; Volver</button>
                <h2idh2idlasslass="text-lg font-semibold mb-4 text-center">Selecciona una talla:</h2>
                <div iidd="tallas-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
            </div>

            <div id="screen-accion" class="screen">
                 <button class="back-btn mb-4 text-slate-500 hover:text-slate-800">&larr; Volver a Tallas</button>
                 <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-1">Registrar Movimiento</h2>
                    <p id="item-seleccionado" class="text-slate-500 mb-6"></p>

                    <div class="mb-4">
                        <label for="cantidad" class="block text-sm font-medium text-slate-700 mb-1">Cantidad</label>
                        <input type="number" id="cantidad" min="1" value="1" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Movimiento</label>
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btn-entrada" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-semibold transition-all">
                                <i class="fas fa-plus mr-2"></i>Entrada Almacén
                            </button>
                             <button id="btn-salida" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-slate-300 text-slate-500 font-semibold transition-all">
                                <i class="fas fa-minus mr-2"></i>Salida a Tienda
                            </button>
                        </div>
                    </div>
                    
                    <div id="destino-container" class="mb-6 hidden">
                        <label for="destino" class="block text-sm font-medium text-slate-700 mb-1">Destino</label>
                        <select id="destino" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="tiendaVP">Tienda VP</option>
                            <option value="tiendaPII">Tienda PII</option>
                        </select>
                    </div>

                    <button id="btn-confirmar" class="w-full bg-sky-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-sky-600 transition-transform transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed">Confirmar</button>
                 </div>
            </div>

            <div id="screen-stock" class="screen">
                 <h2 class="text-2xl font-bold mb-4">Inventario Actual</h2>
                 <div class="flex justify-between items-center mb-4">
                    <input type="text" id="stock-search" placeholder="Buscar prenda..." class="p-2 border border-slate-300 rounded-lg w-1/2">
                    <button id="btn-export-csv" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar a CSV
                    </button>
                 </div>
                 <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3">Prenda</th>
                                <th scope="col" class="px-6 py-3 text-center">Almacén</th>
                                <th scope="col" class="px-6 py-3 text-center">Tienda VP</th>
                                <th scope="col" class="px-6 py-3 text-center">Tienda PII</th>
                                <th scope="col" class="px-6 py-3 text-center font-bold">Total</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body">
                           <tr><td colspan="5" class="text-center p-8"><i class="fas fa-spinner fa-spin text-2xl text-sky-500"></i><p class="mt-2">Cargando stock...</p></td></tr>
                        </tbody>
                    </table>
                 </div>
            </div>

        </main>

        <!-- Modal de Confirmación -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 text-center max-w-sm mx-auto">
                <div id="modal-icon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                     <i class="fas fa-check text-green-600 text-2xl"></i>
                </div>
                <h3 id="modal-title" class="text-lg font-medium text-slate-900">¡Hecho!</h3>
                <p id="modal-message" class="text-sm text-slate-500 mt-2">El movimiento de stock ha sido registrado correctamente.</p>
                <button id="modal-close" class="mt-4 w-full bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold">Aceptar</button>
            </div>
        </div>

    </div>

    <script type="module">
        // Envolvemos todo en un try...catch para mostrar errores en pantalla
        try {
            const errorPanel = document.getElementById('error-panel');
            const errorMessage = document.getElementById('error-message');

            function showError(message) {
                errorMessage.textContent = message;
                errorPanel.classList.remove('hidden');
            }

            // --- CÓDIGO DE LA APLICACIÓN ---
            
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getFirestore, doc, getDoc, setDoc, increment, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // ==================================================================
            // ¡¡¡ATENCIÓN!!!
            // Pega aquí SOLAMENTE tu apiKey. El resto ya está configurado.
            // ==================================================================
            const firebaseConfig = {
              apiKey: "AIzaSyD1Zujz9sNiG7GYLkv5wUFWOPDIbF6DrBU", // <--- PEGA TU API KEY AQUÍ
              authDomain: "stock-ropa.firebaseapp.com",
              projectId: "stock-ropa",
              storageBucket: "stock-ropa.appspot.com",
              messagingSenderId: "289770874193",
              appId: "1:289770874193:web:37cb97c578bde1a1b89f70"
            };
            
            // Verificación de que la apiKey ha sido cambiada
            if (firebaseConfig.apiKey === "AQUÍ_VA_TU_API_KEY") {
                showError("Error de configuración: No has pegado tu 'apiKey' en el archivo HTML. Por favor, edita el archivo y añade tu clave.");
                throw new Error("firebaseConfig.apiKey no ha sido configurada.");
            }

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const SECRET_KEY = "stock-cooperativa-2a8b3c4d-1e9f-4b2c-8d7e-5f6a7b8c9d0e";

            const productos = {
              "Guardería": { "Babi": { tallas: ["00", "0", "1", "2", "3"] }, "Camiseta": { "Manga Corta": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Manga Larga": { tallas: ["00", "0", "1", "2", "3", "4"] } }, "Pantalón": { "Corto": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Largo": { tallas: ["00", "0", "1", "2", "3", "4", "6"] } }, "Malla": { tallas: ["00", "0", "1", "2", "3"] }, "Chaqueta": { tallas: ["00", "0", "1", "2", "3", "4"] }, "Chándal": { tallas: ["3", "4"] } },
              "Resto de Alumnos": { "Pantalón mostaza": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] }, "Largo": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] } }, "Polo": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] } }, "Falda": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)", "48"] }, "Sueter": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)"] }, "Babi infantil": { tallas: ["1", "2", "4", "6"] }, "Chándal": { tallas: ["1", "2", "3", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Sport": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Largo": { tallas: ["2", "3", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Malla Sport": { tallas: ["12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Camiseta": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Sudadera": { tallas: ["XS", "S", "M", "L", "XL", "XXL", "XXXL"] }, "Leotardos": { tallas: ["4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL"] }, "Calcetines": { tallas: ["4", "6", "8", "10", "12", "14"] }, "Calcetas": { tallas: ["4", "6", "8", "10", "12", "14"] } }
            };
            const iconosPrendas = { "Babi": "fas fa-shirt", "Camiseta": "fas fa-tshirt", "Pantalón": "fas fa-user-tie", "Malla": "fas fa-socks", "Chaqueta": "fas fa-user-secret", "Chándal": "fas fa-running", "Pantalón mostaza": "fas fa-user-tie", "Polo": "fas fa-tshirt", "Falda": "fas fa-female", "Sueter": "fas fa-user-ninja", "Babi infantil": "fas fa-child", "Sport": "fas fa-volleyball-ball", "Malla Sport": "fas fa-running", "Sudadera": "fas fa-user-secret", "Leotardos": "fas fa-socks", "Calcetines": "fas fa-socks", "Calcetas": "fas fa-socks", "default": "fas fa-tag" };

            let seleccion = { seccion: null, prenda: null, variante: null, talla: null, historial: [] };
            let stockData = [];

            const screens = document.querySelectorAll('.screen');
            const prendasGrid = document.getElementById('prendas-grid');
            const variantesGrid = document.getElementById('variantes-grid');
            const tallasGrid = document.getElementById('tallas-grid');
            const itemSeleccionadoP = document.getElementById('item-seleccionado');
            const cantidadInput = document.getElementById('cantidad');
            const btnEntrada = document.getElementById('btn-entrada');
            const btnSalida = document.getElementById('btn-salida');
            const destinoContainer = document.getElementById('destino-container');
            const destinoSelect = document.getElementById('destino');
            const btnConfirmar = document.getElementById('btn-confirmar');
            const modal = document.getElementById('modal');
            const modalIcon = document.getElementById('modal-icon');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalClose = document.getElementById('modal-close');
            const btnVerStock = document.getElementById('btn-ver-stock');
            const btnInicio = document.getElementById('btn-inicio');
            const stockSearchInput = document.getElementById('stock-search');
            const btnExportCSV = document.getElementById('btn-export-csv');

            function goToScreen(screenId) {
                screens.forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                if(screenId !== 'screen-inicio') {
                    seleccion.historial.push(screenId);
                }
            }

            function goBack() {
                const currentScreen = seleccion.historial.pop();
                const previousScreenId = seleccion.historial[seleccion.historial.length - 1] || 'screen-inicio';
                if (currentScreen === 'screen-prendas') seleccion.seccion = null;
                if (currentScreen === 'screen-variantes' || currentScreen === 'screen-tallas') seleccion.prenda = null;
                if (currentScreen === 'screen-tallas' && seleccion.variante) seleccion.variante = null;
                if (currentScreen === 'screen-accion') seleccion.talla = null;
                goToScreen(previousScreenId);
            }

            function renderPrendas(seccion) {
                prendasGrid.innerHTML = '';
                const prendas = productos[seccion];
                for (const prendaNombre in prendas) {
                    const iconClass = iconosPrendas[prendaNombre] || iconosPrendas['default'];
                    const button = document.createElement('button');
                    button.className = 'prenda-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center fade-in';
                    button.dataset.prenda = prendaNombre;
                    button.innerHTML = `<i class="${iconClass} text-3xl text-slate-500 mb-2"></i><span class="block text-md font-semibold">${prendaNombre}</span>`;
                    prendasGrid.appendChild(button);
                }
            }

            function renderVariantes(seccion, prenda) {
                variantesGrid.innerHTML = '';
                const variantes = productos[seccion][prenda];
                for (const varianteNombre in variantes) {
                    if (varianteNombre !== 'tallas') {
                        const button = document.createElement('button');
                        button.className = 'variante-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center fade-in';
                        button.dataset.variante = varianteNombre;
                        button.innerHTML = `<span class="block text-lg font-semibold">${varianteNombre}</span>`;
                        variantesGrid.appendChild(button);
                    }
                }
            }

            function renderTallas(tallas) {
                tallasGrid.innerHTML = '';
                tallas.forEach(talla => {
                    const button = document.createElement('button');
                    button.className = 'talla-btn bg-white p-3 rounded-lg shadow-md hover:bg-sky-100 transition-all text-center font-semibold fade-in';
                    button.dataset.talla = talla;
                    button.textContent = talla;
                    tallasGrid.appendChild(button);
                }
            }
            
            document.body.addEventListener('click', (e) => {
                if (e.target.closest('.seccion-btn')) {
                    seleccion.seccion = e.target.closest('.seccion-btn').dataset.seccion;
                    renderPrendas(seleccion.seccion);
                    goToScreen('screen-prendas');
                }
                else if (e.target.closest('.prenda-btn')) {
                    seleccion.prenda = e.target.closest('.prenda-btn').dataset.prenda;
                    const item = productos[seleccion.seccion][seleccion.prenda];
                    if (item['Manga Corta'] || item['Corto'] || item['Largo']) {
                        renderVariantes(seleccion.seccion, seleccion.prenda);
                        goToScreen('screen-variantes');
                    } else {
                        seleccion.variante = null;
                        renderTallas(item.tallas);
                        goToScreen('screen-tallas');
                    }
                }
                else if (e.target.closest('.variante-btn')) {
                    seleccion.variante = e.target.closest('.variante-btn').dataset.variante;
                    const tallas = productos[seleccion.seccion][seleccion.prenda][seleccion.variante].tallas;
                    renderTallas(tallas);
                    goToScreen('screen-tallas');
                }
                else if (e.target.closest('.talla-btn')) {
                    seleccion.talla = e.target.closest('.talla-btn').dataset.talla;
                    let itemText = `${seleccion.prenda} - ${seleccion.talla}`;
                    if (seleccion.variante) {
                        itemText = `${seleccion.prenda} (${seleccion.variante}) - ${seleccion.talla}`;
                    }
                    itemSeleccionadoP.textContent = itemText;
                    goToScreen('screen-accion');
                }
                else if (e.target.closest('.back-btn')) {
                    goBack();
                }
            });

            let tipoMovimiento = 'entrada';
            btnEntrada.addEventListener('click', () => {
                tipoMovimiento = 'entrada';
                btnEntrada.classList.remove('border-slate-300', 'text-slate-500', 'bg-white');
                btnEntrada.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
                btnSalida.classList.add('border-slate-300', 'text-slate-500');
                btnSalida.classList.remove('border-red-500', 'bg-red-50', 'text-red-700');
                destinoContainer.classList.add('hidden');
            });

            btnSalida.addEventListener('click', () => {
                tipoMovimiento = 'salida';
                btnSalida.classList.remove('border-slate-300', 'text-slate-500', 'bg-white');
                btnSalida.classList.add('border-red-500', 'bg-red-50', 'text-red-700');
                btnEntrada.classList.add('border-slate-300', 'text-slate-500');
                btnEntrada.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
                destinoContainer.classList.remove('hidden');
            });

            btnConfirmar.addEventListener('click', async () => {
                const cantidad = parseInt(cantidadInput.value);
                if (!cantidad || cantidad < 1) {
                    showModal('Error', 'La cantidad debe ser un número mayor que cero.', 'error');
                    return;
                }

                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';

                const docId = `${seleccion.seccion}_${seleccion.prenda}_${seleccion.variante || ''}_${seleccion.talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const docRef = doc(db, SECRET_KEY, docId);
                
                try {
                    const docSnap = await getDoc(docRef);
                    let updateData = {};
                    
                    if (tipoMovimiento === 'entrada') {
                        updateData.stockAlmacen = increment(cantidad);
                    } else {
                        const destino = destinoSelect.value;
                        updateData.stockAlmacen = increment(-cantidad);
                        if (destino === 'tiendaVP') {
                            updateData.stockVP = increment(cantidad);
                        } else {
                            updateData.stockPII = increment(cantidad);
                        }
                    }

                    if (!docSnap.exists()) {
                        const initialData = {
                            seccion: seleccion.seccion, prenda: seleccion.prenda, variante: seleccion.variante || '', talla: seleccion.talla,
                            stockAlmacen: 0, stockVP: 0, stockPII: 0, ...updateData
                        };
                        await setDoc(docRef, initialData);
                    } else {
                        await setDoc(docRef, updateData, { merge: true });
                    }

                    showModal('¡Hecho!', 'El movimiento de stock ha sido registrado correctamente.');
                    resetApp();

                } catch (error) {
                    console.error("Error al actualizar el documento: ", error);
                    showModal('Error', 'No se pudo registrar el movimiento. Revisa la conexión y las reglas de seguridad de Firebase.', 'error');
                } finally {
                    btnConfirmar.disabled = false;
                    btnConfirmar.textContent = 'Confirmar';
                }
            });
            
            function resetApp() {
                seleccion = { seccion: null, prenda: null, variante: null, talla: null, historial: [] };
                cantidadInput.value = 1;
                goToScreen('screen-inicio');
            }

            function showModal(title, message, type = 'success') {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalIcon.innerHTML = '';
                if (type === 'success') {
                    modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4';
                    modalIcon.innerHTML = '<i class="fas fa-check text-green-600 text-2xl"></i>';
                } else {
                    modalIcon.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4';
                    modalIcon.innerHTML = '<i class="fas fa-times text-red-600 text-2xl"></i>';
                }
                modal.classList.remove('hidden');
            }
            modalClose.addEventListener('click', () => modal.classList.add('hidden'));

            btnVerStock.addEventListener('click', () => {
                goToScreen('screen-stock');
                btnVerStock.classList.add('hidden');
                btnInicio.classList.remove('hidden');
            });

            btnInicio.addEventListener('click', () => {
                resetApp();
                btnVerStock.classList.remove('hidden');
                btnInicio.classList.add('hidden');
            });
            
            function renderStockTable(data) {
                const tableBody = document.getElementById('stock-table-body');
                tableBody.innerHTML = '';
                
                if (data.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8">No hay datos de stock. Empieza a registrar movimientos.</td></tr>';
                    return;
                }

                data.sort((a, b) => {
                    if (a.seccion < b.seccion) return -1; if (a.seccion > b.seccion) return 1;
                    if (a.prenda < b.prenda) return -1; if (a.prenda > b.prenda) return 1;
                    if (a.variante < b.variante) return -1; if (a.variante > b.variante) return 1;
                    const tallaA = parseInt(a.talla); const tallaB = parseInt(b.talla);
                    if (!isNaN(tallaA) && !isNaN(tallaB)) { return tallaA - tallaB; }
                    return a.talla.localeCompare(b.talla);
                });

                data.forEach(item => {
                    const total = item.stockAlmacen + item.stockVP + item.stockPII;
                    const nombreCompleto = `${item.prenda} ${item.variante || ''} - Talla: ${item.talla}`;
                    const row = `<tr class="bg-white border-b hover:bg-slate-50"><th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap"><span class="block">${nombreCompleto}</span><span class="block text-xs text-slate-400">${item.seccion}</span></th><td class="px-6 py-4 text-center">${item.stockAlmacen}</td><td class="px-6 py-4 text-center">${item.stockVP}</td><td class="px-6 py-4 text-center">${item.stockPII}</td><td class="px-6 py-4 text-center font-bold text-slate-800">${total}</td></tr>`;
                    tableBody.innerHTML += row;
                });
            }
            
            const unsub = onSnapshot(collection(db, SECRET_KEY), (querySnapshot) => {
                stockData = [];
                querySnapshot.forEach((doc) => {
                    stockData.push({ id: doc.id, ...doc.data() });
                });
                renderStockTable(stockData);
            }, (error) => {
                console.error("Error al obtener stock: ", error);
                 showError(`Error al conectar con la base de datos: ${error.message}. Revisa las reglas de seguridad y la configuración de Firebase.`);
            });

            stockSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filteredData = stockData.filter(item => {
                    const nombreCompleto = `${item.seccion} ${item.prenda} ${item.variante || ''} ${item.talla}`.toLowerCase();
                    return nombreCompleto.includes(searchTerm);
                });
                renderStockTable(filteredData);
            });
            
            btnExportCSV.addEventListener('click', () => {
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Seccion,Prenda,Variante,Talla,Stock Almacen,Stock Tienda VP,Stock Tienda PII,Total\n";

                stockData.forEach(item => {
                    const total = item.stockAlmacen + item.stockVP + item.stockPII;
                    const row = [item.seccion, item.prenda, item.variante || '', item.talla, item.stockAlmacen, item.stockVP, item.stockPII, total].join(",");
                    csvContent += row + "\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "inventario_cooperativa.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            goToScreen('screen-inicio');

        } catch (e) {
            // Si algo falla, lo mostramos en el panel de error
            const errorPanel = document.getElementById('error-panel');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = `Error crítico: ${e.message}. Asegúrate de que has pegado correctamente la configuración de Firebase.`;
            errorPanel.classList.remove('hidden');
            console.error(e);
        }
    </script>
</body>
</html>
