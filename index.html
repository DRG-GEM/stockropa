<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Stock - Cooperativa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .detail-view {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .detail-view.active {
            max-height: 1000px; /* Suficientemente grande para el contenido */
            opacity: 1;
        }
        .prenda-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 50%;
            border: 3px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-2xl mx-auto p-4 md:p-6">

        <!-- Cabecera y Navegación -->
        <header class="flex justify-between items-center mb-6 pb-4 border-b border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-sky-500 text-white p-2 rounded-lg">
                    <i class="fas fa-boxes-stacked"></i>
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-slate-700">Gestión de Stock</h1>
            </div>
            <div id="nav-buttons" class="flex gap-2 text-sm">
                 <button id="btn-inicio" class="bg-sky-500 text-white px-3 py-2 rounded-lg font-semibold hover:bg-sky-600 transition-colors">Registrar</button>
                 <button id="btn-ver-stock" class="bg-slate-200 text-slate-600 px-3 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Stock</button>
                 <button id="btn-carga-masiva" class="bg-slate-200 text-slate-600 px-3 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Carga</button>
                 <button id="btn-historial" class="bg-slate-200 text-slate-600 px-3 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Historial</button>
                 <button id="btn-stats" class="bg-slate-200 text-slate-600 px-3 py-2 rounded-lg font-semibold hover:bg-slate-300 transition-colors">Stats</button>
            </div>
        </header>

        <!-- Contenedor de Pantallas -->
        <main id="screens-container">

            <!-- Pantalla de Registro -->
            <div id="screen-registro" class="screen active">
                <div id="seccion-selector">
                    <h2 class="text-lg font-semibold mb-4 text-center">1. Selecciona una sección:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button data-seccion="Guardería" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                            <i class="fas fa-child-reaching text-4xl text-teal-500 mb-3"></i>
                            <span class="block text-xl font-bold">Guardería</span>
                        </button>
                        <button data-seccion="Resto de Alumnos" class="seccion-btn bg-white p-6 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center">
                            <i class="fas fa-user-graduate text-4xl text-indigo-500 mb-3"></i>
                            <span class="block text-xl font-bold">Resto de Alumnos</span>
                        </button>
                    </div>
                </div>

                <div id="prenda-selector" class="hidden mt-8">
                    <h2 class="text-lg font-semibold mb-4 text-center">2. Selecciona una prenda:</h2>
                    <div id="prendas-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="detail-view-container" class="detail-view mt-6">
                    <button id="back-to-prendas" class="mb-4 text-slate-500 hover:text-slate-800">&larr; Volver a prendas</button>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-center mb-4">
                            <img id="detail-image" src="" alt="" class="prenda-img">
                        </div>
                        <div class="flex justify-center items-center gap-4 mb-6">
                            <h2 id="detail-title" class="text-2xl font-bold text-center"></h2>
                            <div id="detail-stock-display" class="hidden w-16 h-16 rounded-full flex flex-col items-center justify-center font-bold text-lg leading-tight">
                                <span id="stock-number" class="text-2xl"></span>
                                <span class="text-xs font-medium">Stock</span>
                            </div>
                        </div>
                        <div id="detail-options" class="space-y-6"></div>
                    </div>
                </div>
            </div>

            <!-- Pantalla de Ver Stock -->
            <div id="screen-stock" class="screen">
                 <h2 class="text-2xl font-bold mb-4">Inventario Actual</h2>
                 <div class="flex justify-between items-center mb-4">
                    <input type="text" id="stock-search" placeholder="Buscar prenda..." class="p-2 border border-slate-300 rounded-lg w-1/2">
                    <button id="btn-export-csv" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Exportar a CSV
                    </button>
                 </div>
                 <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left whitespace-nowrap">Prenda</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Almacén</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Tienda VP</th>
                                <th scope="col" class="px-4 py-3 text-center whitespace-nowrap">Tienda PII</th>
                                <th scope="col" class="px-4 py-3 text-center font-bold whitespace-nowrap">Total</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body"></tbody>
                    </table>
                 </div>
                 <p class="text-xs text-slate-400 text-right mt-2 md:hidden">← Desliza la tabla para ver más →</p>
            </div>

            <!-- Pantalla de Carga Masiva -->
            <div id="screen-bulk-load" class="screen">
                <h2 class="text-2xl font-bold mb-4">Carga Masiva de Stock</h2>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <div class="mb-4">
                        <label for="bulk-product-select" class="block text-sm font-medium text-slate-700 mb-1">Selecciona una Prenda</label>
                        <select id="bulk-product-select" class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-sky-500 focus:border-sky-500">
                            <option value="">-- Elige un producto --</option>
                        </select>
                    </div>
                    <div id="bulk-load-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-6"></div>
                    <button id="btn-bulk-save" class="w-full mt-6 bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 transition-transform transform hover:scale-105 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>Guardar Cambios</button>
                </div>
            </div>

            <!-- Pantalla de Historial -->
            <div id="screen-history" class="screen">
                <h2 class="text-2xl font-bold mb-4">Historial de Movimientos</h2>
                <div class="overflow-x-auto bg-white rounded-lg shadow">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">Fecha</th>
                                <th scope="col" class="px-4 py-3">Prenda</th>
                                <th scope="col" class="px-4 py-3">Movimiento</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>

            <!-- Pantalla de Estadísticas -->
            <div id="screen-stats" class="screen">
                <h2 class="text-2xl font-bold mb-6">Estadísticas</h2>
                <div class="space-y-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-slate-600">Artículos con Stock Bajo (Menos de 10)</h3>
                        <div id="low-stock-list" class="bg-white p-4 rounded-xl shadow-md space-y-3"></div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-3 text-slate-600">Top 5 Prendas Más Populares (Salidas)</h3>
                        <div id="top-products-list" class="bg-white p-4 rounded-xl shadow-md space-y-3"></div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Modal de Resumen -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-auto">
                <div class="flex items-center gap-3 mb-4">
                    <div id="modal-icon" class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                         <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <h3 id="modal-title" class="text-lg font-medium text-slate-900">Movimiento Registrado</h3>
                </div>
                <div id="modal-summary" class="text-sm text-left space-y-2"></div>
                <button id="modal-close" class="mt-6 w-full bg-sky-500 text-white px-4 py-2 rounded-lg font-semibold">Aceptar</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, writeBatch, addDoc, query, orderBy, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyD1Zujz9sNiG7GYLkv5wUFWOPDIbF6DrBU",
          authDomain: "stock-ropa.firebaseapp.com",
          projectId: "stock-ropa",
          storageBucket: "stock-ropa.appspot.com",
          messagingSenderId: "289770874193",
          appId: "1:289770874193:web:37cb97c578bde1a1b89f70"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const SECRET_KEY = "stock-cooperativa-2a8b3c4d-1e9f-4b2c-8d7e-5f6a7b8c9d0e";
        const HISTORY_COLLECTION = "history";
        const LOW_STOCK_THRESHOLD = 10;
        const LOW_STOCK_ALERT_THRESHOLD = 5;

        const productos = {
          "Guardería": { "Babi": { tallas: ["00", "0", "1", "2", "3"] }, "Camiseta": { "Manga Corta": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Manga Larga": { tallas: ["00", "0", "1", "2", "3", "4"] } }, "Pantalón": { "Corto": { tallas: ["0", "1", "2", "3", "4", "6"] }, "Largo": { tallas: ["00", "0", "1", "2", "3", "4", "6"] } }, "Malla": { tallas: ["00", "0", "1", "2", "3"] }, "Chaqueta": { tallas: ["00", "0", "1", "2", "3", "4"] }, "Chándal": { tallas: ["3", "4"] } },
          "Resto de Alumnos": { "Pantalón mostaza": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] }, "Largo": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "20", "22", "24", "26", "28", "30"] } }, "Polo": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] } }, "Falda": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)", "48"] }, "Sueter": { tallas: ["2", "4", "6", "8", "10", "12", "14", "16", "18", "20 (S)", "22 (M)", "24 (L)", "26 (XL)"] }, "Babi infantil": { tallas: ["1", "2", "4", "6"] }, "Chándal": { tallas: ["1", "2", "3", "4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Sport": { "Corto": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Largo": { tallas: ["2", "3", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Malla Sport": { tallas: ["12", "14", "16", "S", "M", "L", "XL", "XXL"] }, "Camiseta": { "Manga Corta": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] }, "Manga Larga": { tallas: ["1", "2", "4", "6", "8", "10", "12", "14", "16", "18", "S", "M", "L", "XL", "XXL"] } }, "Sudadera": { tallas: ["XS", "S", "M", "L", "XL", "XXL", "XXXL"] }, "Leotardos": { tallas: ["4", "6", "8", "10", "12", "14", "16", "S", "M", "L", "XL"] }, "Calcetines": { tallas: ["4", "6", "8", "10", "12", "14"] }, "Calcetas": { tallas: ["4", "6", "8", "10", "12", "14"] } }
        };
        
        const imagenesPrendas = {
            "Babi": "https://www.bayon.es/41802-superlarge_default/baby-personalizado-colegio-y-guarderia-cuadros-gomas-bayon.jpg",
            "Camiseta": "https://i.imgur.com/example.png",
            "Pantalón": "https://i.imgur.com/example.png",
            "Malla": "https://i.imgur.com/example.png",
            "Chaqueta": "https://i.imgur.com/example.png",
            "Chándal": "https://i.imgur.com/example.png",
            "Pantalón mostaza": "https://i.imgur.com/example.png",
            "Polo": "https://i.imgur.com/example.png",
            "Falda": "https://i.imgur.com/example.png",
            "Sueter": "https://i.imgur.com/example.png",
            "Babi infantil": "https://i.imgur.com/example.png",
            "Sport": "https://i.imgur.com/example.png",
            "Malla Sport": "https://skollsports.com/855-superlarge_default/mallas-largas-mujer-yoga-granate.jpg",
            "Sudadera": "https://i.imgur.com/example.png",
            "Leotardos": "https://i.imgur.com/example.png",
            "Calcetines": "https://i.imgur.com/example.png",
            "Calcetas": "https://i.imgur.com/example.png",
            "default": "https://placehold.co/80x80/e2e8f0/4a5568?text=?"
        };

        let seleccion = { seccion: null, prenda: null, variante: null, talla: null, destino: null };
        let stockData = [];
        let historyData = [];

        const screens = document.querySelectorAll('.screen');
        const modal = document.getElementById('modal');
        const modalIcon = document.getElementById('modal-icon');
        const modalTitle = document.getElementById('modal-title');
        const modalSummary = document.getElementById('modal-summary');
        const modalClose = document.getElementById('modal-close');
        
        // Elementos de Navegación y Pantallas
        const btnInicio = document.getElementById('btn-inicio');
        const btnVerStock = document.getElementById('btn-ver-stock');
        const btnCargaMasiva = document.getElementById('btn-carga-masiva');
        const btnHistorial = document.getElementById('btn-historial');
        const btnStats = document.getElementById('btn-stats');
        const seccionSelector = document.getElementById('seccion-selector');
        const prendaSelector = document.getElementById('prenda-selector');
        const prendasGrid = document.getElementById('prendas-grid');
        const detailViewContainer = document.getElementById('detail-view-container');
        const detailTitle = document.getElementById('detail-title');
        const detailOptions = document.getElementById('detail-options');
        const backToPrendasBtn = document.getElementById('back-to-prendas');
        const detailStockDisplay = document.getElementById('detail-stock-display');
        const stockNumberSpan = document.getElementById('stock-number');
        const detailImage = document.getElementById('detail-image');
        const historyTableBody = document.getElementById('history-table-body');
        const lowStockList = document.getElementById('low-stock-list');
        const topProductsList = document.getElementById('top-products-list');

        function goToScreen(screenId) {
            screens.forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            btnInicio.classList.toggle('bg-sky-500', screenId === 'screen-registro');
            btnInicio.classList.toggle('bg-slate-200', screenId !== 'screen-registro');
            btnVerStock.classList.toggle('bg-sky-500', screenId === 'screen-stock');
            btnVerStock.classList.toggle('bg-slate-200', screenId !== 'screen-stock');
            btnCargaMasiva.classList.toggle('bg-sky-500', screenId === 'screen-bulk-load');
            btnCargaMasiva.classList.toggle('bg-slate-200', screenId !== 'screen-bulk-load');
            btnHistorial.classList.toggle('bg-sky-500', screenId === 'screen-history');
            btnHistorial.classList.toggle('bg-slate-200', screenId !== 'screen-history');
            btnStats.classList.toggle('bg-sky-500', screenId === 'screen-stats');
            btnStats.classList.toggle('bg-slate-200', screenId !== 'screen-stats');
        }

        // --- NUEVO FLUJO DE REGISTRO ---
        
        document.querySelectorAll('.seccion-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                seleccion.seccion = btn.dataset.seccion;
                seccionSelector.classList.add('hidden');
                prendaSelector.classList.remove('hidden');
                renderPrendas(seleccion.seccion);
            });
        });

        function renderPrendas(seccion) {
            prendasGrid.innerHTML = '';
            const prendas = productos[seccion];
            for (const prendaNombre in prendas) {
                const imageUrl = imagenesPrendas[prendaNombre] || imagenesPrendas['default'];
                const button = document.createElement('button');
                button.className = 'prenda-btn bg-white p-4 rounded-xl shadow-md hover:shadow-lg hover:-translate-y-1 transition-all text-center flex flex-col items-center justify-center fade-in';
                button.dataset.prenda = prendaNombre;
                button.innerHTML = `<img src="${imageUrl}" alt="${prendaNombre}" class="prenda-img mb-2"><span class="block text-md font-semibold">${prendaNombre}</span>`;
                prendasGrid.appendChild(button);
            }
        }
        
        prendasGrid.addEventListener('click', (e) => {
            const prendaBtn = e.target.closest('.prenda-btn');
            if (!prendaBtn) return;

            seleccion.prenda = prendaBtn.dataset.prenda;
            prendaSelector.classList.add('hidden');
            detailViewContainer.classList.add('active');
            renderDetailView();
        });

        backToPrendasBtn.addEventListener('click', () => {
            detailViewContainer.classList.remove('active');
            prendaSelector.classList.remove('hidden');
            detailStockDisplay.classList.add('hidden');
            seleccion = { seccion: seleccion.seccion, prenda: null, variante: null, talla: null, destino: null };
        });

        function renderDetailView() {
            const { seccion, prenda } = seleccion;
            const item = productos[seccion][prenda];
            
            const imageUrl = imagenesPrendas[prenda] || imagenesPrendas['default'];
            detailImage.src = imageUrl;
            detailImage.alt = prenda;

            detailTitle.textContent = prenda;
            detailOptions.innerHTML = '';

            let variantsHTML = '';
            const hasVariants = !item.tallas;
            if (hasVariants) {
                const variantKeys = Object.keys(item);
                seleccion.variante = variantKeys[0];
                variantsHTML = `
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">Variante</label>
                        <div class="flex gap-2">${variantKeys.map((v, i) => `
                            <button class="variant-btn flex-1 p-2 rounded-lg border-2 ${i === 0 ? 'bg-sky-100 border-sky-500' : 'bg-white'}" data-variante="${v}">${v}</button>
                        `).join('')}</div>
                    </div>
                `;
            } else {
                seleccion.variante = null;
            }

            detailOptions.innerHTML += variantsHTML;
            detailOptions.innerHTML += `
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Talla</label>
                    <div id="detail-tallas-grid" class="grid grid-cols-3 sm:grid-cols-5 gap-2"></div>
                </div>
                <div>
                    <label for="detail-cantidad" class="block text-sm font-medium text-slate-700 mb-1">Cantidad</label>
                    <input type="number" id="detail-cantidad" min="1" value="1" class="w-full p-3 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Tipo de Movimiento</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="detail-btn-entrada" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-semibold"><i class="fas fa-plus mr-2"></i>Entrada Almacén</button>
                        <button id="detail-btn-salida" class="movimiento-tipo-btn p-3 rounded-lg border-2 border-slate-300 text-slate-500 font-semibold"><i class="fas fa-minus mr-2"></i>Salida a Tienda</button>
                    </div>
                </div>
                <div id="detail-destino-container" class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-2">Destino</label>
                    <div class="flex gap-2">
                        <button class="destino-btn flex-1 p-2 rounded-lg border-2" data-destino="tiendaVP">Tienda VP</button>
                        <button class="destino-btn flex-1 p-2 rounded-lg border-2" data-destino="tiendaPII">Tienda PII</button>
                    </div>
                </div>
                <button id="detail-btn-confirmar" class="w-full bg-sky-500 text-white p-4 rounded-lg font-bold text-lg hover:bg-sky-600 disabled:bg-slate-300" disabled>Confirmar Movimiento</button>
            `;
            renderDetailTallas();
        }

        function renderDetailTallas() {
            const { seccion, prenda, variante } = seleccion;
            const item = variante ? productos[seccion][prenda][variante] : productos[seccion][prenda];
            const tallasGrid = document.getElementById('detail-tallas-grid');
            tallasGrid.innerHTML = ''; 

            item.tallas.forEach(talla => {
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const stockItem = stockData.find(d => d.id === docId);
                const stockAlmacen = stockItem ? stockItem.stockAlmacen || 0 : 0;
                
                const stockColor = stockAlmacen < LOW_STOCK_THRESHOLD ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-600';

                const buttonHTML = `
                    <button class="detail-talla-btn bg-white p-2 text-sm rounded-lg border-2 flex flex-col items-center justify-center h-16" data-talla="${talla}" data-stock="${stockAlmacen}">
                        <span class="font-bold text-base">${talla}</span>
                        <span class="text-xs ${stockColor} px-1.5 py-0.5 rounded-full mt-1">Disp: ${stockAlmacen}</span>
                    </button>
                `;
                tallasGrid.innerHTML += buttonHTML;
            });
        }
        
        document.body.addEventListener('click', (e) => {
            const confirmBtn = document.getElementById('detail-btn-confirmar');
            const entradaBtn = document.getElementById('detail-btn-entrada');
            const salidaBtn = document.getElementById('detail-btn-salida');
            const destinoContainer = document.getElementById('detail-destino-container');

            // Seleccionar Variante
            if (e.target.matches('.variant-btn')) {
                document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                e.target.classList.add('bg-sky-100', 'border-sky-500');
                seleccion.variante = e.target.dataset.variante;
                seleccion.talla = null;
                confirmBtn.disabled = true;
                detailStockDisplay.classList.add('hidden');
                renderDetailTallas();
            }
            // Seleccionar Talla
            const tallaBtn = e.target.closest('.detail-talla-btn');
            if (tallaBtn) {
                document.querySelectorAll('.detail-talla-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                tallaBtn.classList.add('bg-sky-100', 'border-sky-500');
                seleccion.talla = tallaBtn.dataset.talla;
                
                const stockValue = parseInt(tallaBtn.dataset.stock);
                stockNumberSpan.textContent = stockValue;
                detailStockDisplay.classList.remove('hidden');
                
                detailStockDisplay.classList.remove('bg-sky-100', 'text-sky-700', 'bg-red-100', 'text-red-700');
                if (stockValue < LOW_STOCK_THRESHOLD) {
                    detailStockDisplay.classList.add('bg-red-100', 'text-red-700');
                } else {
                    detailStockDisplay.classList.add('bg-sky-100', 'text-sky-700');
                }

                confirmBtn.disabled = false;
            }
            // Tipo de Movimiento
            if (e.target.closest('#detail-btn-entrada')) {
                entradaBtn.className = 'movimiento-tipo-btn p-3 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-semibold';
                salidaBtn.className = 'movimiento-tipo-btn p-3 rounded-lg border-2 border-slate-300 text-slate-500 font-semibold';
                destinoContainer.classList.add('hidden');
                seleccion.destino = null;
            }
            if (e.target.closest('#detail-btn-salida')) {
                salidaBtn.className = 'movimiento-tipo-btn p-3 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 font-semibold';
                entradaBtn.className = 'movimiento-tipo-btn p-3 rounded-lg border-2 border-slate-300 text-slate-500 font-semibold';
                destinoContainer.classList.remove('hidden');
                const firstDestinoBtn = destinoContainer.querySelector('.destino-btn');
                if (firstDestinoBtn) {
                     document.querySelectorAll('.destino-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                    firstDestinoBtn.classList.add('bg-sky-100', 'border-sky-500');
                    seleccion.destino = firstDestinoBtn.dataset.destino;
                }
            }
            // Seleccionar Destino
            const destinoBtn = e.target.closest('.destino-btn');
            if (destinoBtn) {
                document.querySelectorAll('.destino-btn').forEach(b => b.classList.remove('bg-sky-100', 'border-sky-500'));
                destinoBtn.classList.add('bg-sky-100', 'border-sky-500');
                seleccion.destino = destinoBtn.dataset.destino;
            }
            // Confirmar
            if (e.target.matches('#detail-btn-confirmar')) {
                handleConfirmClick();
            }
        });

        async function handleConfirmClick() {
            const currentSelection = { ...seleccion };
            const cantidad = parseInt(document.getElementById('detail-cantidad').value);
            if (!cantidad || cantidad < 1) {
                showModal('Error', 'La cantidad debe ser un número mayor que cero.', false);
                return;
            }
            const confirmBtn = document.getElementById('detail-btn-confirmar');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registrando...';
            
            const esSalida = document.getElementById('detail-btn-salida').classList.contains('border-red-500');
            const docId = `${currentSelection.seccion}_${currentSelection.prenda}_${currentSelection.variante || ''}_${currentSelection.talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
            const docRef = doc(db, SECRET_KEY, docId);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const docSnap = await transaction.get(docRef);
                    const stockActual = docSnap.exists() ? docSnap.data() : { stockAlmacen: 0, stockVP: 0, stockPII: 0 };
                    
                    let datosActualizados = { ...stockActual };
                    let resumen = {};

                    if (!esSalida) {
                        resumen = {
                            lugar: 'Almacén',
                            stockAnterior: stockActual.stockAlmacen || 0,
                            stockNuevo: (stockActual.stockAlmacen || 0) + cantidad
                        };
                        datosActualizados.stockAlmacen = (stockActual.stockAlmacen || 0) + cantidad;
                    } else {
                        if (!currentSelection.destino) {
                            throw new Error('Debes seleccionar un destino para la salida.');
                        }
                        const stockDestinoKey = currentSelection.destino === 'tiendaVP' ? 'stockVP' : 'stockPII';
                        resumen = {
                            lugar: currentSelection.destino === 'tiendaVP' ? 'Tienda VP' : 'Tienda PII',
                            stockAnteriorAlmacen: stockActual.stockAlmacen || 0,
                            stockNuevoAlmacen: (stockActual.stockAlmacen || 0) - cantidad,
                            stockAnteriorTienda: stockActual[stockDestinoKey] || 0,
                            stockNuevoTienda: (stockActual[stockDestinoKey] || 0) + cantidad
                        };
                        datosActualizados.stockAlmacen = (stockActual.stockAlmacen || 0) - cantidad;
                        datosActualizados[stockDestinoKey] = (stockActual[stockDestinoKey] || 0) + cantidad;
                    }

                    const finalData = {
                        seccion: currentSelection.seccion, prenda: currentSelection.prenda, variante: currentSelection.variante || '', talla: currentSelection.talla,
                        ...datosActualizados
                    };
                    
                    transaction.set(docRef, finalData);
                    
                    const historyRef = doc(collection(db, HISTORY_COLLECTION));
                    transaction.set(historyRef, {
                        ...currentSelection,
                        cantidad: cantidad,
                        tipo: esSalida ? 'salida' : 'entrada',
                        timestamp: serverTimestamp()
                    });

                    if (datosActualizados.stockAlmacen < LOW_STOCK_ALERT_THRESHOLD) {
                        const alertRef = doc(collection(db, "mail"));
                        transaction.set(alertRef, {
                            to: 'tu-email@example.com', // CAMBIAR ESTO
                            message: {
                                subject: `Alerta de Stock Bajo: ${currentSelection.prenda}`,
                                text: `El stock para ${currentSelection.prenda} (${currentSelection.variante || ''}) Talla: ${currentSelection.talla} ha bajado a ${datosActualizados.stockAlmacen}.`
                            }
                        });
                    }

                    showSummaryModal(currentSelection, cantidad, esSalida, resumen);
                });

                resetApp();

            } catch (error) {
                console.error("Error al actualizar el documento: ", error);
                showModal('Error', `No se pudo registrar el movimiento. ${error.message}`, false);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = 'Confirmar Movimiento';
            }
        }
        
        function resetApp() {
            seleccion = { seccion: null, prenda: null, variante: null, talla: null, destino: null };
            seccionSelector.classList.remove('hidden');
            prendaSelector.classList.add('hidden');
            detailViewContainer.classList.remove('active');
            detailStockDisplay.classList.add('hidden');
            goToScreen('screen-registro');
        }

        function showModal(title, summaryHTML, isSuccess = true) {
            modalTitle.textContent = title;
            modalSummary.innerHTML = summaryHTML;
            modalIcon.innerHTML = isSuccess 
                ? '<i class="fas fa-check text-green-600 text-2xl"></i>' 
                : '<i class="fas fa-times text-red-600 text-2xl"></i>';
            modalIcon.className = `flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full ${isSuccess ? 'bg-green-100' : 'bg-red-100'}`;
            modal.classList.remove('hidden');
        }

        function showSummaryModal(currentSelection, cantidad, esSalida, resumen) {
            const { prenda, variante, talla } = currentSelection;
            const itemDescription = `${prenda} ${variante || ''} (Talla: ${talla})`;
            const movimiento = esSalida 
                ? `<span class="font-semibold text-red-600">SALIDA de ${cantidad}</span> unidades`
                : `<span class="font-semibold text-green-600">ENTRADA de ${cantidad}</span> unidades`;

            let summaryHTML = `
                <p><strong>Prenda:</strong> ${itemDescription}</p>
                <p><strong>Movimiento:</strong> ${movimiento}</p>
                <hr class="my-2">`;
            
            if (esSalida) {
                summaryHTML += `
                    <p><strong>Almacén:</strong> ${resumen.stockAnteriorAlmacen} &rarr; <span class="font-bold text-lg">${resumen.stockNuevoAlmacen}</span></p>
                    <p><strong>${resumen.lugar}:</strong> ${resumen.stockAnteriorTienda} &rarr; <span class="font-bold text-lg">${resumen.stockNuevoTienda}</span></p>
                `;
            } else {
                 summaryHTML += `
                    <p><strong>Lugar:</strong> ${resumen.lugar}</p>
                    <p><strong>Stock Anterior:</strong> ${resumen.stockAnterior}</p>
                    <p><strong>Stock Resultante:</strong> <span class="font-bold text-lg">${resumen.stockNuevo}</span></p>
                `;
            }

            showModal('Movimiento Registrado', summaryHTML, true);
        }

        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        // Navegación principal
        btnInicio.addEventListener('click', () => { resetApp(); });
        btnVerStock.addEventListener('click', () => { goToScreen('screen-stock'); });
        btnCargaMasiva.addEventListener('click', () => { goToScreen('screen-bulk-load'); });
        btnHistorial.addEventListener('click', () => { goToScreen('screen-history'); });
        btnStats.addEventListener('click', () => {
            renderStats();
            goToScreen('screen-stats');
        });
        
        // --- RENDERIZADO DE TABLAS Y STATS ---
        function renderStockTable(data) {
            const tableBody = document.getElementById('stock-table-body');
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8">No hay datos de stock.</td></tr>';
                return;
            }
            data.sort((a, b) => {
                if (a.seccion < b.seccion) return -1; if (a.seccion > b.seccion) return 1;
                if (a.prenda < b.prenda) return -1; if (a.prenda > b.prenda) return 1;
                if (a.variante < b.variante) return -1; if (a.variante > b.variante) return 1;
                const tallaA = parseInt(a.talla); const tallaB = parseInt(b.talla);
                if (!isNaN(tallaA) && !isNaN(tallaB)) { return tallaA - tallaB; }
                return a.talla.localeCompare(b.talla);
            });
            data.forEach(item => {
                const total = (item.stockAlmacen || 0) + (item.stockVP || 0) + (item.stockPII || 0);
                const nombreCompleto = `${item.prenda} ${item.variante || ''} - Talla: ${item.talla}`;
                const stockAlmacen = item.stockAlmacen || 0;
                const stockClass = stockAlmacen < LOW_STOCK_THRESHOLD ? 'text-red-500 font-bold' : '';

                const row = `<tr class="bg-white border-b hover:bg-slate-50"><th scope="row" class="px-4 py-4 font-medium text-slate-900 whitespace-nowrap"><span class="block">${nombreCompleto}</span><span class="block text-xs text-slate-400">${item.seccion}</span></th><td class="px-4 py-4 text-center ${stockClass}">${stockAlmacen}</td><td class="px-4 py-4 text-center">${item.stockVP || 0}</td><td class="px-4 py-4 text-center">${item.stockPII || 0}</td><td class="px-4 py-4 text-center font-bold text-slate-800">${total}</td></tr>`;
                tableBody.innerHTML += row;
            });
        }
        
        function renderHistoryTable(data) {
            historyTableBody.innerHTML = '';
            if (data.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="3" class="text-center p-8">No hay movimientos registrados.</td></tr>';
                return;
            }
            data.forEach(item => {
                const { prenda, variante, talla, cantidad, tipo, destino, timestamp } = item;
                const itemDescription = `${prenda} ${variante || ''} (Talla: ${talla})`;
                const date = timestamp ? timestamp.toDate().toLocaleString('es-ES') : 'N/A';
                
                let movimientoHTML = '';
                if (tipo === 'entrada') {
                    movimientoHTML = `<span class="font-semibold text-green-600">+${cantidad}</span> en Almacén`;
                } else {
                    const lugar = destino === 'tiendaVP' ? 'Tienda VP' : 'Tienda PII';
                    movimientoHTML = `<span class="font-semibold text-red-600">-${cantidad}</span> a ${lugar}`;
                }

                const row = `<tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-4 py-4 text-slate-500">${date}</td>
                    <td class="px-4 py-4 font-medium">${itemDescription}</td>
                    <td class="px-4 py-4">${movimientoHTML}</td>
                </tr>`;
                historyTableBody.innerHTML += row;
            });
        }

        function renderStats() {
            // Low Stock
            const lowStockItems = stockData.filter(item => (item.stockAlmacen || 0) < LOW_STOCK_THRESHOLD)
                                           .sort((a, b) => (a.stockAlmacen || 0) - (b.stockAlmacen || 0));
            lowStockList.innerHTML = '';
            if (lowStockItems.length === 0) {
                lowStockList.innerHTML = '<p class="text-slate-500">¡No hay artículos con stock bajo!</p>';
            } else {
                lowStockItems.forEach(item => {
                    const nombreCompleto = `${item.prenda} ${item.variante || ''} - Talla: ${item.talla}`;
                    lowStockList.innerHTML += `<div class="flex justify-between items-center"><p>${nombreCompleto}</p><p class="font-bold text-red-500">${item.stockAlmacen || 0}</p></div>`;
                });
            }

            // Top Products
            const sales = historyData.filter(item => item.tipo === 'salida');
            const productCounts = sales.reduce((acc, item) => {
                const name = `${item.prenda} ${item.variante || ''}`;
                acc[name] = (acc[name] || 0) + item.cantidad;
                return acc;
            }, {});

            const sortedProducts = Object.entries(productCounts)
                                         .sort(([, a], [, b]) => b - a)
                                         .slice(0, 5);
            topProductsList.innerHTML = '';
            if (sortedProducts.length === 0) {
                topProductsList.innerHTML = '<p class="text-slate-500">Aún no hay datos de salidas.</p>';
            } else {
                sortedProducts.forEach(([name, count]) => {
                    topProductsList.innerHTML += `<div class="flex justify-between items-center"><p>${name}</p><p class="font-bold text-sky-600">${count} uds.</p></div>`;
                });
            }
        }

        // --- LISTENERS DE DATOS ---
        onSnapshot(collection(db, SECRET_KEY), (querySnapshot) => {
            stockData = [];
            querySnapshot.forEach((doc) => {
                stockData.push({ id: doc.id, ...doc.data() });
            });
            renderStockTable(stockData);
        });

        const historyQuery = query(collection(db, HISTORY_COLLECTION), orderBy('timestamp', 'desc'));
        onSnapshot(historyQuery, (querySnapshot) => {
            historyData = [];
            querySnapshot.forEach((doc) => {
                historyData.push(doc.data());
            });
            renderHistoryTable(historyData);
        });

        // --- CÓDIGO DE CARGA MASIVA Y OTROS ---
        const stockSearchInput = document.getElementById('stock-search');
        const btnExportCSV = document.getElementById('btn-export-csv');
        const bulkProductSelect = document.getElementById('bulk-product-select');
        const bulkLoadGrid = document.getElementById('bulk-load-grid');
        const btnBulkSave = document.getElementById('btn-bulk-save');

        stockSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = stockData.filter(item => `${item.seccion} ${item.prenda} ${item.variante || ''} ${item.talla}`.toLowerCase().includes(searchTerm));
            renderStockTable(filteredData);
        });
        
        btnExportCSV.addEventListener('click', () => {
            let csvContent = "data:text/csv;charset=utf-8,Seccion,Prenda,Variante,Talla,Stock Almacen,Stock Tienda VP,Stock Tienda PII,Total\n";
            stockData.forEach(item => {
                const total = (item.stockAlmacen || 0) + (item.stockVP || 0) + (item.stockPII || 0);
                const row = [item.seccion, item.prenda, item.variante || '', item.talla, item.stockAlmacen || 0, item.stockVP || 0, item.stockPII || 0, total].join(",");
                csvContent += row + "\n";
            });
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csvContent));
            link.setAttribute("download", "inventario_cooperativa.csv");
            link.click();
        });
        
        function populateBulkProductSelect() {
            for (const seccion in productos) {
                for (const prenda in productos[seccion]) {
                    const item = productos[seccion][prenda];
                    if (item.tallas) {
                        const option = document.createElement('option');
                        option.value = `${seccion}|${prenda}`;
                        option.textContent = `${seccion} - ${prenda}`;
                        bulkProductSelect.appendChild(option);
                    } else {
                        for (const variante in item) {
                            const option = document.createElement('option');
                            option.value = `${seccion}|${prenda}|${variante}`;
                            option.textContent = `${seccion} - ${prenda} (${variante})`;
                            bulkProductSelect.appendChild(option);
                        }
                    }
                }
            }
        }

        bulkProductSelect.addEventListener('change', async (e) => {
            const value = e.target.value;
            bulkLoadGrid.innerHTML = '<div class="col-span-full text-center"><i class="fas fa-spinner fa-spin text-2xl text-sky-500"></i></div>';
            btnBulkSave.disabled = true;
            if (!value) { bulkLoadGrid.innerHTML = ''; return; }

            const [seccion, prenda, variante] = value.split('|');
            const item = variante ? productos[seccion][prenda][variante] : productos[seccion][prenda];
            
            bulkLoadGrid.innerHTML = '';
            for (const talla of item.tallas) {
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const docSnap = await getDoc(doc(db, SECRET_KEY, docId));
                const currentStock = docSnap.exists() ? docSnap.data().stockAlmacen || 0 : 0;
                bulkLoadGrid.innerHTML += `<div><label class="block text-sm font-medium text-slate-700 mb-1">${talla}</label><input type="number" min="0" value="${currentStock}" class="w-full p-2 border border-slate-300 rounded-lg" data-talla="${talla}"></div>`;
            }
            btnBulkSave.disabled = false;
        });

        btnBulkSave.addEventListener('click', async () => {
            const value = bulkProductSelect.value;
            if (!value) return;
            btnBulkSave.disabled = true;
            btnBulkSave.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            const [seccion, prenda, variante] = value.split('|');
            const batch = writeBatch(db);

            bulkLoadGrid.querySelectorAll('input').forEach(input => {
                const talla = input.dataset.talla;
                const newStock = parseInt(input.value) || 0;
                const docId = `${seccion}_${prenda}_${variante || ''}_${talla}`.replace(/\s+/g, '_').replace(/__/g, '_');
                const data = { seccion, prenda, variante: variante || '', talla, stockAlmacen: newStock };
                batch.set(doc(db, SECRET_KEY, docId), data, { merge: true });
            });

            try {
                await batch.commit();
                showModal('¡Guardado!', 'El stock se ha actualizado correctamente.');
            } catch (error) {
                console.error("Error en carga masiva: ", error);
                showModal('Error', 'No se pudo guardar el stock.', false);
            } finally {
                btnBulkSave.disabled = false;
                btnBulkSave.innerHTML = 'Guardar Cambios';
            }
        });

        // Inicialización
        populateBulkProductSelect();
        goToScreen('screen-registro');

    </script>
</body>
</html>
